<template>
  <div class="dashboard-wrapper">
    <div class="dashboard-container">
      <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo-container">
          <svg class="logo-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="logoGradientDash" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#6d28d9;stop-opacity:1" />
              </linearGradient>
            </defs>
            <circle cx="30" cy="50" r="25" fill="url(#logoGradientDash)" opacity="0.8" stroke="black" stroke-width="2"/>
            <circle cx="70" cy="50" r="25" fill="url(#logoGradientDash)" opacity="0.8" stroke="black" stroke-width="2"/>
            <path d="M 30 35 Q 50 20 70 35" stroke="#a78bfa" stroke-width="4" fill="none" stroke-linecap="round"/>
            <circle cx="30" cy="45" r="4" fill="white" stroke="black" stroke-width="1"/>
            <circle cx="70" cy="45" r="4" fill="white" stroke="black" stroke-width="1"/>
            <path d="M 20 55 Q 30 65 40 55" stroke="white" stroke-width="3" fill="none" stroke-linecap="round"/>
            <path d="M 60 55 Q 70 65 80 55" stroke="white" stroke-width="3" fill="none" stroke-linecap="round"/>
          </svg>
          <h2>PingMe</h2>
        </div>
        <div class="user-info">
          <div class="avatar">{{ userAvatar }}</div>
          <span>{{ currentUser?.username }}</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <button
          :class="['nav-btn', { active: activeTab === 'friends' }]"
          @click="switchTab('friends')"
        >
          üë• Znajomi
        </button>
        <button
          :class="['nav-btn', { active: activeTab === 'events' }]"
          @click="switchTab('events')"
        >
          üìÖ Wydarzenia
        </button>
        <button
          :class="['nav-btn', { active: activeTab === 'gallery' }]"
          @click="switchTab('gallery')"
        >
          üñºÔ∏è Galeria
        </button>
        <button
          :class="['nav-btn', { active: activeTab === 'settings' }]"
          @click="switchTab('settings')"
        >
          ‚öôÔ∏è Ustawienia
        </button>
      </nav>

      <button class="logout-btn" @click="handleLogout">
        üö™ Wyloguj siƒô
      </button>
    </div>

    <div class="main-content">
      <div v-if="activeTab === 'friends' && !selectedFriend" class="content-section">
        <Friends :currentUser="currentUser" @open-chat="openChat" />
      </div>

      <div v-if="activeTab === 'events'" class="content-section">
        <Events :currentUser="currentUser" />
      </div>

      <div v-if="activeTab === 'gallery'" class="content-section">
        <Gallery :currentUser="currentUser" />
      </div>

      <div v-if="activeTab === 'settings'" class="content-section">
        <Settings
          :currentUser="currentUser"
          @close-settings="closeSettings"
          @avatar-changed="updateAvatar"
          @theme-changed="handleThemeChange"
          @text-size-changed="handleTextSizeChange"
        />
      </div>

      <div v-if="selectedFriend" class="content-section">
        <ChatRoom
          :currentUser="currentUser"
          :friend="selectedFriend"
          @close-chat="closeChat"
        />
      </div>
    </div>
    </div>

    <footer class="dashboard-footer">
      <div class="footer-content">
        <a href="mailto:kontakt@test.com" class="footer-link">
          <div class="icon-wrapper">
            <svg class="envelope-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M3 7L12 13L21 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="icon-letter">i</span>
          </div>
          <span>kontakt@test.com</span>
        </a>
        <a href="tel:123213321" class="footer-link">
          <svg class="phone-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>123-213-321</span>
        </a>
      </div>
    </footer>
  </div>
</template>

<script>
import Friends from './Friends.vue'
import ChatRoom from './ChatRoom.vue'
import Settings from './Settings.vue'
import Events from './Events.vue'
import Gallery from './Gallery.vue'
import { applyTheme, getTextSizeClass } from '../themes.js'

export default {
  name: 'Dashboard',
  components: {
    Friends,
    ChatRoom,
    Settings,
    Events,
    Gallery
  },
  data() {
    return {
      currentUser: null,
      activeTab: 'friends',
      selectedFriend: null,
      userAvatar: localStorage.getItem('avatar') || 'ü¶Å',
      apiUrl: process.env.VUE_APP_API_URL || 'http://localhost:8000/api'
    }
  },
  async mounted() {
    const userString = localStorage.getItem('user')
    if (userString) {
      this.currentUser = JSON.parse(userString)
      // Try to load user settings from server
      await this.loadUserSettings()
    }

    // Apply saved theme
    const savedTheme = localStorage.getItem('theme') || 'purpleDream'
    applyTheme(savedTheme)

    // Apply saved text size
    const savedTextSize = localStorage.getItem('textSize') || 'medium'
    document.body.classList.add(getTextSizeClass(savedTextSize))
  },
  methods: {
    handleLogout() {
      localStorage.removeItem('user')
      this.$router.push('/login')
    },
    openChat(friend) {
      this.selectedFriend = friend
      this.activeTab = 'friends'
    },
    closeChat() {
      this.selectedFriend = null
    },
    switchTab(tab) {
      this.activeTab = tab
      this.selectedFriend = null
    },
    closeSettings() {
      this.activeTab = 'friends'
    },
    updateAvatar(avatar) {
      this.userAvatar = avatar
    },
    handleThemeChange(themeName) {
      // Theme is already applied by Settings component
      // This ensures the entire page updates
      applyTheme(themeName)
    },
    handleTextSizeChange(size) {
      // Text size is already applied by Settings component
      // This ensures the entire page updates
      document.body.classList.remove('text-size-small', 'text-size-medium', 'text-size-large')
      document.body.classList.add(getTextSizeClass(size))
    },
    async loadUserSettings() {
      try {
        const response = await fetch(`${this.apiUrl}/auth/users/${this.currentUser.id}/settings`)
        if (response.ok) {
          const settings = await response.json()

          // Update localStorage with server settings if they exist
          if (settings.theme) {
            localStorage.setItem('theme', settings.theme)
            applyTheme(settings.theme)
          }
          if (settings.textSize) {
            localStorage.setItem('textSize', settings.textSize)
            document.body.classList.remove('text-size-small', 'text-size-medium', 'text-size-large')
            document.body.classList.add(getTextSizeClass(settings.textSize))
          }
          if (settings.avatar) {
            localStorage.setItem('avatar', settings.avatar)
            this.userAvatar = settings.avatar
          }
        }
      } catch (error) {
        console.error('Error loading user settings:', error)
        // Fail silently - use localStorage defaults
      }
    }
  }
}
</script>

<style scoped>
.dashboard-wrapper {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, var(--color-background1) 0%, var(--color-background2) 50%, var(--color-background3) 100%);
}

.dashboard-container {
  display: flex;
  flex: 1;
  height: calc(100vh - 80px);
}

.logo-container {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 15px;
}

.logo-icon {
  width: 45px;
  height: 45px;
  filter: drop-shadow(0 0 15px var(--color-primaryLight));
  animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

.sidebar {
  width: 280px;
  background: linear-gradient(180deg, var(--color-primary) 15%, rgba(0, 0, 0, 0.6) 100%);
  border-right: 2px solid var(--color-border);
  display: flex;
  flex-direction: column;
  padding: 20px;
}

.sidebar-header {
  margin-bottom: 30px;
}

.sidebar-header h2 {
  color: var(--color-primaryLight);
  font-size: 28px;
  margin-bottom: 20px;
  text-shadow: 0 0 20px var(--color-primaryLight);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 12px;
  border: 1px solid var(--color-border);
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primaryDark) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 18px;
}

.user-info span {
  color: var(--color-text);
  font-weight: 600;
}

.sidebar-nav {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.nav-btn {
  width: 100%;
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0.3);
  border: 2px solid var(--color-border);
  border-radius: 12px;
  color: var(--color-text);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  text-align: left;
}

.nav-btn:hover {
  background: var(--color-primary);
  border-color: var(--color-primaryLight);
  transform: translateX(5px);
}

.nav-btn.active {
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primaryDark) 100%);
  border-color: var(--color-primaryLight);
  color: white;
  box-shadow: 0 4px 15px var(--color-primary);
}

.logout-btn {
  width: 100%;
  padding: 15px 20px;
  background: rgba(239, 68, 68, 0.2);
  border: 2px solid rgba(239, 68, 68, 0.3);
  border-radius: 12px;
  color: var(--color-error);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.logout-btn:hover {
  background: rgba(239, 68, 68, 0.3);
  border-color: #ef4444;
  transform: scale(1.02);
}

.main-content {
  flex: 1;
  display: flex;
  padding: 20px;
  overflow: hidden;
}

.content-section {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.dashboard-footer {
  width: 100%;
  background: linear-gradient(135deg, var(--color-primary) 15%, rgba(0, 0, 0, 0.9) 100%);
  backdrop-filter: blur(10px);
  border-top: 2px solid var(--color-border);
  padding: 15px 20px;
}

.footer-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 40px;
  flex-wrap: wrap;
}

.footer-link {
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--color-text);
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s;
  padding: 8px 16px;
  border-radius: 8px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--color-border);
}

.footer-link:hover {
  color: var(--color-primaryLight);
  background: var(--color-primary);
  border-color: var(--color-primaryLight);
  transform: translateY(-2px);
  text-decoration: none;
}

.icon-wrapper {
  position: relative;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.envelope-icon {
  width: 24px;
  height: 24px;
  color: var(--color-primaryLight);
}

.icon-letter {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 10px;
  font-weight: bold;
  color: var(--color-primaryLight);
  margin-top: 1px;
}

.phone-icon {
  width: 20px;
  height: 20px;
  color: var(--color-primaryLight);
}

/* Responsive Design */
@media (max-width: 1024px) {
  .sidebar {
    width: 240px;
  }

  .sidebar-header h2 {
    font-size: 24px;
  }

  .logo-icon {
    width: 40px;
    height: 40px;
  }
}

@media (max-width: 768px) {
  .dashboard-container {
    flex-direction: column;
    height: auto;
  }

  .sidebar {
    width: 100%;
    border-right: none;
    border-bottom: 2px solid rgba(139, 92, 246, 0.3);
    padding: 15px;
  }

  .sidebar-header {
    margin-bottom: 15px;
  }

  .logo-container {
    gap: 10px;
  }

  .logo-icon {
    width: 35px;
    height: 35px;
  }

  .sidebar-header h2 {
    font-size: 22px;
  }

  .user-info {
    padding: 10px;
  }

  .sidebar-nav {
    flex-direction: row;
    gap: 8px;
  }

  .nav-btn {
    flex: 1;
    text-align: center;
    padding: 12px 15px;
  }

  .logout-btn {
    width: 100%;
    margin-top: 10px;
  }

  .main-content {
    padding: 15px;
  }

  .footer-content {
    flex-direction: column;
    gap: 15px;
  }

  .footer-link {
    width: 100%;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .sidebar {
    padding: 10px;
  }

  .logo-icon {
    width: 30px;
    height: 30px;
  }

  .sidebar-header h2 {
    font-size: 20px;
  }

  .user-info {
    font-size: 14px;
  }

  .avatar {
    width: 35px;
    height: 35px;
    font-size: 16px;
  }

  .nav-btn {
    font-size: 14px;
    padding: 10px 12px;
  }

  .logout-btn {
    font-size: 14px;
    padding: 12px 15px;
  }

  .footer-link span {
    font-size: 12px;
  }
}
</style>
